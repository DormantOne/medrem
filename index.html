<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHF Med Scheduler - Universal</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f9; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        .section { margin-bottom: 30px; padding: 20px; border-radius: 8px; border: 1px solid #ddd; }
        .am { background-color: #fffde7; border-left: 5px solid #fbc02d; }
        .pm { background-color: #e8eaf6; border-left: 5px solid #3949ab; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        input[type="time"], textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 15px; box-sizing: border-box; }
        textarea { height: 70px; }
        
        .btn-group { display: flex; gap: 10px; flex-direction: column; }
        
        button { border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 15px; text-align: center; text-decoration: none; display: block; }
        
        /* Google Button Style */
        .btn-google { background-color: #4285F4; color: white; }
        .btn-google:hover { background-color: #3367d6; }
        
        /* Apple/Outlook Button Style */
        .btn-apple { background-color: #333; color: white; }
        .btn-apple:hover { background-color: #000; }

        .troubleshoot { font-size: 0.9em; background: #ffebee; color: #c62828; padding: 15px; border-radius: 5px; margin-top: 20px; border: 1px solid #ffcdd2; }
    </style>
</head>
<body>

<div class="container">
    <h1>CHF Medication Scheduler</h1>
    <p style="text-align:center; color:#666;">Choose the button that matches your calendar.</p>

    <!-- AM SECTION -->
    <div class="section am">
        <h2>‚òÄÔ∏è Morning Meds</h2>
        <label>Time:</label>
        <input type="time" id="amTime" value="08:00">
        <label>Medications:</label>
        <textarea id="amMeds" placeholder="List Morning meds here..."></textarea>
        
        <div class="btn-group">
            <!-- Method A: Direct Google Link -->
            <button class="btn-google" onclick="addToGoogle('AM')">Add to Google Calendar</button>
            <!-- Method B: Apple/Outlook File -->
            <button class="btn-apple" onclick="downloadICS('AM')">Download for Apple / Outlook</button>
        </div>
    </div>

    <!-- PM SECTION -->
    <div class="section pm">
        <h2>üåô Evening Meds</h2>
        <label>Time:</label>
        <input type="time" id="pmTime" value="20:00">
        <label>Medications:</label>
        <textarea id="pmMeds" placeholder="List Evening meds here..."></textarea>
        
        <div class="btn-group">
            <button class="btn-google" onclick="addToGoogle('PM')">Add to Google Calendar</button>
            <button class="btn-apple" onclick="downloadICS('PM')">Download for Apple / Outlook</button>
        </div>
    </div>

    <div class="troubleshoot">
        <strong>‚ö†Ô∏è iPhone / iPad Users: READ THIS</strong><br>
        1. When you tap "Download for Apple", it might save to your <strong>Files App</strong> (blue folder icon).<br>
        2. Go to your home screen, find the "Files" app.<br>
        3. Tap the file (e.g., "AM_Meds.ics").<br>
        4. Tap the <strong>Share Icon</strong> (square with arrow) at the top right.<br>
        5. Scroll and tap the <strong>Calendar</strong> app icon to add it.
    </div>
</div>

<script>
    // 1. Logic for Google Calendar (Opens a web link directly - most reliable for Google)
    function addToGoogle(type) {
        const isAM = type === 'AM';
        const meds = document.getElementById(isAM ? 'amMeds' : 'pmMeds').value;
        const timeStr = document.getElementById(isAM ? 'amTime' : 'pmTime').value;
        
        if (!meds) { alert("Please list your medications first."); return; }

        // Calc times for URL
        const now = new Date();
        const start = new Date(now);
        start.setDate(start.getDate() + 1); // Start tomorrow
        const [h, m] = timeStr.split(':');
        start.setHours(h, m, 0);

        const end = new Date(start);
        end.setMinutes(end.getMinutes() + 15); // 15 min duration

        // Format for Google URL: YYYYMMDDTHHMMSS
        const fmt = (d) => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        
        const title = isAM ? "‚òÄÔ∏è Morning CHF Meds" : "üåô Evening CHF Meds";
        const details = "MEDICATIONS:\n" + meds;
        
        // Build URL
        const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${fmt(start)}/${fmt(end)}&details=${encodeURIComponent(details)}&recur=RRULE:FREQ=DAILY&sf=true&output=xml`;
        
        window.open(url, '_blank');
    }

    // 2. Logic for Apple/Outlook (Download .ics file)
    function downloadICS(type) {
        const isAM = type === 'AM';
        const meds = document.getElementById(isAM ? 'amMeds' : 'pmMeds').value;
        const timeStr = document.getElementById(isAM ? 'amTime' : 'pmTime').value;

        if (!meds) { alert("Please list your medications first."); return; }

        const now = new Date();
        const start = new Date(now);
        start.setDate(start.getDate() + 1); // Start tomorrow
        const [h, m] = timeStr.split(':');
        
        // Format YYYYMMDD
        const y = start.getFullYear();
        const mo = String(start.getMonth()+1).padStart(2,'0');
        const d = String(start.getDate()).padStart(2,'0');
        const dateStr = `${y}${mo}${d}`;
        const timeStart = `${h}${m}00`;

        const title = isAM ? "‚òÄÔ∏è Morning CHF Meds" : "üåô Evening CHF Meds";
        
        let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Meds//EN\nBEGIN:VEVENT\n";
        ics += `UID:${Date.now()}@meds\n`;
        ics += `DTSTAMP:${dateStr}T${timeStart}\n`;
        ics += `DTSTART;TZID=Floating:${dateStr}T${timeStart}\n`;
        ics += `DURATION:PT15M\n`;
        ics += `RRULE:FREQ=DAILY\n`;
        ics += `SUMMARY:${title}\n`;
        ics += `DESCRIPTION:${meds.replace(/\n/g, '\\n')}\n`;
        ics += `BEGIN:VALARM\nTRIGGER:-PT5M\nACTION:DISPLAY\nDESCRIPTION:Meds\nEND:VALARM\n`;
        ics += "END:VEVENT\nEND:VCALENDAR";

        const blob = new Blob([ics], { type: 'text/calendar' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${type}_Meds.ics`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>

</body>
</html>
